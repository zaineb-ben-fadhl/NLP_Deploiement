name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: rg-dreaddit-mlops
  ACR_NAME: acrdreaddit54381
  CONTAINER_APP_NAME: dreaddit-api
  IMAGE_NAME: dreaddit-api

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov httpx
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests/*.py 2>/dev/null)" ]; then
            pytest tests/ -v --cov=app --cov-report=term --cov-report=xml
          else
            echo "âš ï¸ No tests found, skipping test step"
            exit 0
          fi
      
      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}
      
      - name: Build and push Docker image
        run: |
          # Build avec le SHA du commit
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                     ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          # Push vers ACR
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          echo "âœ… Images pushed to ACR"
      
      - name: Deploy to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --cpu 2.0 \
            --memory 4Gi \
            --set-env-vars \
              "MODEL_DIR=/app/artifacts/models/deberta_dreaddit_best" \
              "MAX_LENGTH=128" \
              "MODEL_LOAD_TIMEOUT=300"
          
          echo "âœ… Deployment command sent to Azure"
      
      - name: Wait for deployment
        run: |
          echo "â³ Waiting 60s for deployment to stabilize..."
          sleep 60
      
      - name: Get deployment URL
        id: get-url
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "url=https://$APP_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ API URL: https://$APP_URL"
      
      - name: Health check
        run: |
          echo "ðŸ” Testing liveness endpoint..."
          curl -f ${{ steps.get-url.outputs.url }}/liveness || exit 1
          
          echo "âœ… Liveness check passed"
          echo "âš ï¸ Note: /health may take 2-3 minutes for model loading"
          echo "ðŸŒ Full URL: ${{ steps.get-url.outputs.url }}/docs"
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App**: ${{ env.CONTAINER_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: [${{ steps.get-url.outputs.url }}](${{ steps.get-url.outputs.url }}/docs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Wait 2-3 minutes for model loading" >> $GITHUB_STEP_SUMMARY
          echo "- Test health endpoint: \`curl ${{ steps.get-url.outputs.url }}/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- View API docs: ${{ steps.get-url.outputs.url }}/docs" >> $GITHUB_STEP_SUMMARY